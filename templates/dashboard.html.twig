{% extends 'base.html.twig' %}

{% block title %}EnerGreen - Tableau de bord
{% endblock %}

{% block stylesheets %}
	<style>:root
	{
		--vert-energreen: #1a3020;
		--marron-energreen: #493315;
		--gris-fond: #f4f7f6;
		--blanc: #ffffff;
	}

	body {
		font-family: 'Montserrat', sans-serif;
		background-color: var(--gris-fond);
		color: var(--vert-energreen);
	}

	h1,
	h2 {
		font-family: 'Roboto', sans-serif;
	}

	.dashboard-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 20px;
		padding: 20px;
		max-width: 1200px;
		margin: auto;
	}

	.card {
		background: var(--blanc);
		border-radius: 10px;
		padding: 20px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
	}

	.span-2 {
		grid-column: span 2;
	}
	.span-3 {
		grid-column: span 3;
	}

	.btn-energreen {
		background-color: var(--vert-energreen);
		color: white;
		padding: 10px 20px;
		border-radius: 5px;
		text-decoration: none;
		font-weight: bold;
		border: none;
		transition: opacity 0.3s;
	}

	.btn-energreen-dark {
		background-color: var(--vert-energreen);
		color: white !important;
		padding: 6px 15px;
		border-radius: 4px;
		text-decoration: none;
		font-weight: 600;
		font-size: 0.85rem;
		border: none;
		display: inline-block;
		transition: opacity 0.2s;
	}

	.btn-energreen:hover,
	.btn-energreen-dark:hover {
		opacity: 0.9;
		color: white;
	}

	.nav-pills .nav-link {
		background-color: #f0f2f0;
		color: var(--vert-energreen);
		border: 1px solid var(--vert-energreen);
		margin-left: 5px;
		font-weight: 600;
		transition: all 0.3s;
	}

	.nav-pills .nav-link.active {
		background-color: var(--vert-energreen) !important;
		color: white !important;
		border-color: var(--vert-energreen);
	}

	/* Badge de Note A-F */
	.carbon-grade-badge {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 35px;
		height: 35px;
		border-radius: 6px;
		color: white;
		font-weight: 800;
		margin-left: 10px;
		vertical-align: middle;
	}

	/* EFFET DE FLOU POUR LE DASHBOARD BLOQUÉ */
	.dashboard-locked {
		filter: blur(8px);
		pointer-events: none;
		user-select: none;
		opacity: 0.6;
		transition: all 0.5s ease;
	}

	.onboarding-active {
		position: relative;
		z-index: 10;
		border: 2px solid #2ecc71 !important;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
	}
</style>{% endblock %}{% block body %}

{% for message in app.flashes('success') %}
	<div class="alert alert-success alert-dismissible fade show mx-auto" role="alert" style="max-width: 1200px; margin-top: 20px;">
		<strong>✓</strong>
		{{ message }}
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
{% endfor %}

{% if show_update_reminder %}
	<div class="alert alert-info" style="border-left: 5px solid #2e7d32; background-color: #e8f5e9; max-width: 1200px; margin: 20px auto 0 auto;">
		<i class="fas fa-calendar-alt me-2"></i>
		Cela fait plus d'une semaine que vous n'avez pas mis à jour vos données d'électricité.
		<strong>
			<a href="{{ path('app_calculator_consumption') }}" style="color: #2e7d32; text-decoration: underline;">
				Calculez votre consommation actuelle
			</a>
		</strong>
		pour un meilleur suivi !
	</div>
{% endif %}

<div
	class="dashboard-grid">
	{# SECTION GÉRER LES DONNÉES #}
	{% if logement is null %}
		<section class="card span-3 onboarding-active" style="display: flex; justify-content: space-between; align-items: center; background: #f0f4f1;">
			<div>
				<h2 style="color: #27ae60; margin: 0;">Gérer vos données</h2>
				<p style="margin: 5px 0 0 0;">Saisissez vos données de consommation pour débloquer votre analyse.</p>
			</div>
			<a href="{{ path('app_energreen_welcome') }}" class="btn-energreen">Saisir vos données</a>
		</section>
	{% endif %}

	<div
		class="span-3 dashboard-grid {{ logement is null ? 'dashboard-locked' : '' }}" style="padding: 0; margin: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">

		{# Graphique Consommation Électrique #}
		<section class="card span-2">
			<div style="display: flex; justify-content: space-between; align-items: center;">
				<div>
					<h2 style="font-size: 1.4rem; margin-bottom: 5px;">Historique de la consommation</h2>
					<p id="chartDescription" style="margin: 0; color: #666;">{{ infoMois }}</p>
				</div>
			</div>
			<div style="height: 250px; background: #fafafa; margin-top: 20px; border: 1px solid #eee; padding: 10px;">
				<canvas id="consumptionChart"></canvas>
			</div>
		</section>

		{# Section Suggestions #}
		<section class="card">
			<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
				<h2 style="margin: 0; font-size: 1.4rem;">Suggestions</h2>
				<ul class="nav nav-pills" id="suggestionTabs" role="tablist">
					<li class="nav-item">
						<button class="nav-link active py-1 px-3" id="carbone-tab" data-bs-toggle="pill" data-bs-target="#tab-carbone" type="button" style="font-size: 0.8rem;">Carbone</button>
					</li>
					<li class="nav-item">
						<button class="nav-link py-1 px-3" id="elec-tab" data-bs-toggle="pill" data-bs-target="#tab-elec" type="button" style="font-size: 0.8rem;">Électricité</button>
					</li>
				</ul>
			</div>

			<div class="tab-content">
				<div class="tab-pane fade show active" id="tab-carbone" role="tabpanel">
					<div style="display: flex; flex-direction: column; gap: 10px;">
						{% if suggestions_carbone is defined and suggestions_carbone is not empty %}
							{% for categorie, message in suggestions_carbone|slice(0, 3) %}
								<div style="padding: 10px; border-radius: 8px; background: #f8faf9; border-left: 5px solid var(--vert-energreen);">
									<small>
										<strong>{{ categorie }}</strong>
									</small>
									<p style="margin: 0; font-size: 0.85em; color: #555;">{{ message }}</p>
								</div>
							{% endfor %}
							{% if suggestions_carbone|length > 3 %}
								<button class="btn-energreen-dark mt-2" data-bs-toggle="modal" data-bs-target="#suggestionsModal">
									Voir tout le bilan ({{ suggestions_carbone|length }})
								</button>
							{% endif %}
						{% else %}
							<p class="text-muted small">Aucun bilan trouvé.
								<a href="{{ path('app_formulaire') }}">Calculer mon impact</a>.</p>
						{% endif %}
					</div>
				</div>

				<div class="tab-pane fade" id="tab-elec" role="tabpanel">
					<div style="display: flex; flex-direction: column; gap: 10px;">
						{% if suggestions_elec is defined and suggestions_elec is not empty %}
							{% for titre, message in suggestions_elec %}
								<div style="padding: 10px; border-radius: 8px; background: #f0f7ff; border-left: 5px solid #007bff;">
									<small>
										<strong style="color: #007bff;">{{ titre }}</strong>
									</small>
									<p style="margin: 0; font-size: 0.85em; color: #555;">{{ message }}</p>
								</div>
							{% endfor %}
						{% else %}
							<p class="text-muted small">Saisissez vos consommations pour voir les suggestions.</p>
						{% endif %}
					</div>
				</div>
			</div>
		</section>

		{# IMPACT CARBONE GLOBAL #}
		<section class="card">
			<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
				<h2 style="font-size: 1.4rem; margin: 0;">Impact Global</h2>
			</div>

			{% if latest_bilan %}
				<div style="height: 180px; margin: 10px 0;">
					<canvas id="impactChart"></canvas>
				</div>

				<ul style="list-style: none; padding: 0; margin-top: 10px; font-size: 0.9em;">
					<li style="border-bottom: 1px solid #eee; padding: 5px 0;">
						<strong>Total :
							{{ latest_bilan.total|number_format(0, ',', ' ') }}
							kg CO2/an</strong>
					</li>

					{% if carbon_rating is defined %}
						<li style="padding: 10px 0; display: flex; align-items: center; gap: 10px;">
							<span style="color: #555;">Votre score :</span>
							<div class="carbon-grade-badge" style="background-color: {{ carbon_rating.color }};">
								{{ carbon_rating.label }}
							</div>
						</li>
						<li style="padding-bottom: 10px;">
							<p style="margin: 0; font-size: 0.9em; font-style: italic; color: {{ carbon_rating.color }}; font-weight: 600;">
								« Vous avez une note de
								{{ carbon_rating.label }},
								{% if carbon_rating.label == 'A' or carbon_rating.label == 'B' %}
									bravo pour vos efforts !
								{% elseif carbon_rating.label == 'C' or carbon_rating.label == 'D' %}
									vous êtes sur la bonne voie.
								{% else %}
									des améliorations sont possibles.
								{% endif %}
								»
							</p>
						</li>
					{% endif %}

					<li style="padding: 5px 0; color: #666; border-top: 1px solid #eee;">
						<small>Calculé le
							{{ latest_bilan.createdAt|date('d/m/Y') }}</small>
					</li>
				</ul>
			{% else %}
				<div style="text-align: center; padding: 20px;">
					<p>Aucun bilan trouvé.</p>
					<a href="{{ path('app_formulaire') }}" class="btn-energreen" style="font-size: 0.8em;">Calculer</a>
				</div>
			{% endif %}
		</section>

		{# Coût et Consommation #}
		<section class="card">
			<h2 style="font-size: 1.4rem; margin: 0;" class="mb-3">Coût et consommation</h2>
			<div class="mt-3">
				<div class="mb-3">
					<span class="d-block text-muted small text-uppercase lh-1">Coût estimé (Mois)</span>
					<span class="h2 fw-bold text-success">
						{% if consumption and consumption.estimatedPrice is not null %}
							{{ consumption.estimatedPrice|number_format(2, ',', ' ') }}
							€
						{% else %}
							0,00 €
						{% endif %}
					</span>
				</div>
				<div>
					<span class="d-block text-muted small text-uppercase lh-1">Volume estimé</span>
					<span class="h4 fw-bold">
						{% if consumption and consumption.totalKwh is not null %}
							{{ consumption.totalKwh|number_format(0, ',', ' ') }}
							kWh
						{% else %}
							0 kWh
						{% endif %}
					</span>
				</div>
			</div>

			{% if consumption %}
				<div class="mt-2 border-top pt-2">
					<small class="text-muted">
						Dernier relevé :
						{{ consumption.billingDate|date('d/m/Y') }}
					</small>
				</div>
			{% endif %}
		</section>

		{# Alertes #}
		<section class="card">
			<h2 style="font-size: 1.4rem">Alertes Intelligentes</h2>

			{% if smart_alerts is defined and smart_alerts is not empty %}
				<div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
					{% for alert in smart_alerts %}
						<div class="alert alert-{{ alert.type }} d-flex align-items-center mb-0" role="alert" style="border-left: 5px solid {% if alert.type == 'warning' %}#ffc107{% elseif alert.type == 'danger' %}#dc3545{% else %}#198754{% endif %};">
							<i class="{{ alert.icon }} me-3" style="font-size: 1.5rem;"></i>
							<div>
								<h5 class="alert-heading h6 fw-bold mb-1">{{ alert.title }}</h5>
								<p class="mb-0 small">{{ alert.message|raw }}</p>
							</div>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<div class="alert alert-success d-flex align-items-center mt-3" role="alert">
					<i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
					<div>
						<h5 class="alert-heading h6 fw-bold mb-1">Tout va bien !</h5>
						<p class="mb-0 small">Aucune alerte de consommation détectée pour le moment.</p>
					</div>
				</div>
			{% endif %}
		</section>
	</div>
</div>

{# MODALE SUGGESTIONS #}
{% if suggestions_carbone is defined and suggestions_carbone|length > 3 %}
	<div class="modal fade" id="suggestionsModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header" style="background: var(--vert-energreen); color: white;">
					<h5 class="modal-title">Tous vos conseils Carbone</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					{% for categorie, message in suggestions_carbone %}
						<div class="mb-3 p-2" style="border-bottom: 1px solid #eee;">
							<strong style="color: var(--vert-energreen);">{{ categorie }}</strong>
							<p class="small mb-0">{{ message }}</p>
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
{% endif %}{% endblock %}{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', function () { // --- GRAPHIQUE LINÉAIRE (Mois seulement) ---
const ctxLine = document.getElementById('consumptionChart');
if (ctxLine) {
new Chart(ctxLine.getContext('2d'), {
type: 'line',
data: {
labels: {{ labelsMois|raw }},
datasets: [
{
label: 'Consommation (kWh)',
data: {{ dataMois|raw }},
borderColor: '#1a361c',
backgroundColor: 'rgba(26, 54, 28, 0.1)',
fill: true,
tension: 0.4
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false
}
}
}
});
}

// --- GRAPHIQUE CAMEMBERT ---
{% if latest_bilan %}
const ctxPie = document.getElementById('impactChart');
if (ctxPie) {
new Chart(ctxPie.getContext('2d'), {
type: 'pie',
data: {
labels: [
'Logement',
'Numérique',
'Alimentation',
'Transports',
'Électroménager',
'Textile'
],
datasets: [
{
data: [
{{ latest_bilan.logement }},
{{ latest_bilan.numerique }},
{{ latest_bilan.alimentation }},
{{ latest_bilan.transports }},
{{ latest_bilan.electromenager }},
{{ latest_bilan.textile }}
],
backgroundColor: [
'#2ecc71',
'#3498db',
'#f1c40f',
'#e74c3c',
'#1abc9c',
'#9b59b6'
],
borderWidth: 1
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'right',
labels: {
boxWidth: 12,
font: {
size: 10
}
}
}
}
}
});
}
{% endif %}
});
</script>{% endblock %}
