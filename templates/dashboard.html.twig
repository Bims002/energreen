{% extends 'base.html.twig' %}

{% block title %}EnerGreen - Tableau de bord
{% endblock %}

{% block stylesheets %}
	<style>:root
	{
		--vert-energreen: #1a3020;
		--marron-energreen: #493315;
		--gris-fond: #f4f7f6;
		--blanc: #ffffff;
	}

	body {
		font-family: 'Montserrat', sans-serif;
		background-color: var(--gris-fond);
		color: var(--vert-energreen);
	}

	.nav-pills .nav-link {
		background-color: #f4f7f6; /* Gris clair de fond */
		color: #1a3020 !important;
		border: 1px solid #ced4da !important;
		transition: all 0.2s ease-in-out;
	}

	.nav-pills .nav-link.active {
		background-color: #1a3020 !important; /* Ton vert EnerGreen sombre */
		color: white !important;
		border-color: #1a3020 !important;
	}

	/* Optionnel : petit effet au survol sur le bouton inactif */
	.nav-pills .nav-link:not(.active):hover {
		background-color: #e2e8e6;
		border-color: #adb5bd !important;
	}

	h1,
	h2 {
		font-family: 'Roboto', sans-serif;
	}

	.dashboard-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 20px;
		padding: 20px;
		max-width: 1200px;
		margin: auto;
	}

	.card {
		background: var(--blanc);
		border-radius: 10px;
		padding: 20px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
	}

	.span-2 {
		grid-column: span 2;
	}
	.span-3 {
		grid-column: span 3;
	}

	.btn-energreen {
		background-color: var(--vert-energreen);
		color: white;
		padding: 10px 20px;
		border-radius: 5px;
		text-decoration: none;
		font-weight: bold;
		border: none;
		transition: opacity 0.3s;
	}

	.btn-energreen-dark {
		background-color: var(--vert-energreen);
		color: white !important;
		padding: 6px 15px;
		border-radius: 4px;
		text-decoration: none;
		font-weight: 600;
		font-size: 0.85rem;
		border: none;
		display: inline-block;
		transition: opacity 0.2s;
	}

	.btn-energreen:hover,
	.btn-energreen-dark:hover {
		opacity: 0.9;
		color: white;
	}

	.nav-pills .nav-link {
		background-color: #f0f2f0;
		color: var(--vert-energreen);
		border: 1px solid var(--vert-energreen);
		margin-left: 5px;
		font-weight: 600;
		transition: all 0.3s;
	}

	.nav-pills .nav-link.active {
		background-color: var(--vert-energreen) !important;
		color: white !important;
		border-color: var(--vert-energreen);
	}

	/* Badge de Note A-F */
	.carbon-grade-badge {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 35px;
		height: 35px;
		border-radius: 6px;
		color: white;
		font-weight: 800;
		margin-left: 10px;
		vertical-align: middle;
	}

	/* EFFET DE FLOU POUR LE DASHBOARD BLOQUÉ */
	.dashboard-locked {
		filter: blur(8px);
		pointer-events: none;
		user-select: none;
		opacity: 0.6;
		transition: all 0.5s ease;
	}

	.onboarding-active {
		position: relative;
		z-index: 10;
		border: 2px solid #2ecc71 !important;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
	}
</style>{% endblock %}{% block body %}

{% for message in app.flashes('success') %}
	<div class="alert alert-success alert-dismissible fade show mx-auto" role="alert" style="max-width: 1200px; margin-top: 20px;">
		<strong>✓</strong>
		{{ message }}
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
{% endfor %}



<div
	class="dashboard-grid">
	{# SECTION GÉRER LES DONNÉES #}
	{% if logement is null %}
		<section class="card span-3 onboarding-active" style="display: flex; justify-content: space-between; align-items: center; background: #f0f4f1;">
			<div class="text-center">
				<h2 style="color: #27ae60; margin: 0;">Gérer vos données</h2>
				<p style="margin: 5px 0 0 0;">Saisissez vos données de consommation pour débloquer votre analyse.</p>
			</div>
			<a href="{{ path('app_energreen_welcome') }}" class="btn-energreen">Saisir vos données</a>
		</section>
	{% endif %}

	<div
		class="span-3 dashboard-grid {{ logement is null ? 'dashboard-locked' : '' }}" style="padding: 0; margin: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">

		{# Graphique Consommation Électrique / carbone #}
		<section class="card span-2 shadow-sm border-0 rounded-4">
			<div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
				<div>
					<h2 class="h5 fw-bold mb-1">Historique & Analyses</h2>
					<p id="chartDescription" class="text-muted small mb-0">{{ infoMois }}</p>
				</div>
				
				{# Groupe de boutons pour le switch #}
				<div class="ms-auto">
					<ul class="nav nav-pills" id="chartTabs" role="tablist">
						<li class="nav-item">
							<button class="nav-link py-1 px-3" 
									id="btn-carbon" 
									onclick="switchChart('carbon')" 
									type="button" 
									style="font-size: 0.8rem;">
								Carbone
							</button>
						</li>
						<li class="nav-item">
							<button class="nav-link active py-1 px-3" 
									id="btn-elec" 
									onclick="switchChart('elec')" 
									type="button" 
									style="font-size: 0.8rem;">
								Électricité
							</button>
						</li>
					</ul>
				</div>
			</div>

			<div class="position-relative mt-4 p-2 rounded-3 bg-white border border-light" style="height: 300px;">
				{# Graphique Élec #}
				<div id="container-elec" class="h-100 w-100">
					<canvas id="consumptionChart"></canvas>
				</div>
				{# Graphique Carbone (caché par défaut) #}
				<div id="container-carbon" class="h-100 w-100 d-none">
					<canvas id="carbonChart"></canvas>
				</div>
			</div>
		</section>

		{# Section Suggestions #}
		<section class="card">
			<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
				<h2 style="margin: 0; font-size: 1.4rem;">Suggestions</h2>
				<ul class="nav nav-pills" id="suggestionTabs" role="tablist">
					<li class="nav-item">
						<button class="nav-link active py-1 px-3" id="carbone-tab" data-bs-toggle="pill" data-bs-target="#tab-carbone" type="button" style="font-size: 0.8rem;">Carbone</button>
					</li>
					<li class="nav-item">
						<button class="nav-link py-1 px-3" id="elec-tab" data-bs-toggle="pill" data-bs-target="#tab-elec" type="button" style="font-size: 0.8rem;">Électricité</button>
					</li>
				</ul>
			</div>

			<div class="tab-content">
				<div class="tab-pane fade show active" id="tab-carbone" role="tabpanel">
					<div style="display: flex; flex-direction: column; gap: 10px;">
						{% if suggestions_carbone is defined and suggestions_carbone is not empty %}
							{% for categorie, message in suggestions_carbone|slice(0, 3) %}
								<div style="padding: 10px; border-radius: 8px; background: #f8faf9; border-left: 5px solid var(--vert-energreen);">
									<small>
										<strong>{{ categorie }}</strong>
									</small>
									<p style="margin: 0; font-size: 0.85em; color: #555;">{{ message }}</p>
								</div>
							{% endfor %}
							{% if suggestions_carbone|length > 3 %}
								<button class="btn-energreen-dark mt-2" data-bs-toggle="modal" data-bs-target="#suggestionsModal">
									Voir tout le bilan ({{ suggestions_carbone|length }})
								</button>
							{% endif %}
						{% else %}
							<p class="text-muted small">Aucun bilan trouvé.
								<a href="{{ path('app_formulaire') }}">Calculer mon impact</a>.</p>
						{% endif %}
					</div>
				</div>

				<div class="tab-pane fade" id="tab-elec" role="tabpanel">
					<div style="display: flex; flex-direction: column; gap: 10px;">
						{% if suggestions_elec is defined and suggestions_elec is not empty %}
							{% for titre, message in suggestions_elec %}
								<div style="padding: 10px; border-radius: 8px; background: #f0f7ff; border-left: 5px solid #007bff;">
									<small>
										<strong style="color: #007bff;">{{ titre }}</strong>
									</small>
									<p style="margin: 0; font-size: 0.85em; color: #555;">{{ message }}</p>
								</div>
							{% endfor %}
						{% else %}
							<p class="text-muted small">Saisissez vos consommations pour voir les suggestions.</p>
						{% endif %}
					</div>
				</div>
			</div>
		</section>

		{# IMPACT CARBONE GLOBAL - DESIGN MODERNISÉ #}
		<section class="card border-0 shadow-sm rounded-4 overflow-hidden">
			<div class="p-3">
				<div class="d-flex align-items-center justify-content-between mb-3">
					<h2 class="h5 fw-bold text-dark mb-0">Impact Global</h2>
					{% if latest_bilan and carbon_rating is defined %}
						<div class="badge rounded-pill shadow-sm" 
							style="background-color: {{ carbon_rating.color }}; padding: 8px 15px; font-size: 0.85rem;">
							Score {{ carbon_rating.label }}
						</div>
					{% endif %}
				</div>

				{% if latest_bilan %}
					{# Conteneur du graphique avec le total au centre #}
					<div class="position-relative" style="height: 220px; margin: 20px 0;">
						<canvas id="impactChart"></canvas>
						<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
							<span class="d-block text-muted small text-uppercase fw-semibold" style="font-size: 0.65rem; letter-spacing: 1px;">Total</span>
							<span class="h3 fw-bold mb-0 d-block text-dark">{{ latest_bilan.total|number_format(0, ',', ' ') }}</span>
							<span class="text-muted small" style="font-size: 0.65rem;">kg CO₂/an</span>
						</div>
					</div>

					{# Légende interactive ou Message de conseil #}
					<div class="mt-3 text-center">
						<div class="p-2 rounded-3" style="background-color: {{ carbon_rating.color }}15;"> {# 15 = 15% opacité #}
							<p class="small mb-0 fw-semibold" style="color: {{ carbon_rating.color }}; line-height: 1.4;">
								« {{ carbon_rating.label == 'A' or carbon_rating.label == 'B' ? 'Bravo pour vos efforts exemplaires !' : 
								(carbon_rating.label == 'C' or carbon_rating.label == 'D' ? 'Vous êtes sur la bonne voie, continuez !' : 
								'Des opportunités de réduction importantes existent.') }} »
							</p>
						</div>
						
						<div class="mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
							<small class="text-muted" style="font-size: 0.7rem;">
								<i class="fas fa-history me-1"></i> {{ latest_bilan.createdAt|date('d/m/Y') }}
							</small>
							<a href="{{ path('app_formulaire') }}" class="text-decoration-none small fw-bold text-success" style="font-size: 0.75rem;">
								Refaire le test <i class="fas fa-chevron-right ms-1"></i>
							</a>
						</div>
					</div>
				{% else %}
					<div class="text-center py-5">
						<div class="mb-3 text-muted opacity-25">
							<i class="fas fa-leaf fa-3x"></i>
						</div>
						<p class="small text-muted">Prêt à mesurer votre impact ?</p>
						<a href="{{ path('app_formulaire') }}" class="btn btn-sm btn-success rounded-pill px-4">Commencer</a>
					</div>
				{% endif %}
			</div>
		</section>

		{# Coût et Consommation - Version Dashboard #}
		<section class="card border-0 shadow-sm rounded-4 overflow-hidden">
			<div class="card-header bg-white border-0 py-3">
				<div class="d-flex align-items-center">
					<div class="p-2 bg-success bg-opacity-10 rounded-3 me-3">
						<i class="bi bi-lightning-charge-fill text-success"></i>
					</div>
					<h2 class="h5 mb-0 fw-bold">Coût et consommation</h2>
				</div>
			</div>

			<div class="card-body pt-0">
				<div class="row g-4">
					{# Bloc Prix #}
					<div class="col-12">
						<div class="p-3 rounded-4 bg-light">
							<div class="d-flex justify-content-between align-items-center mb-2">
								<span class="text-muted small text-uppercase fw-semibold">Coût estimé (Mois)</span>
								<i class="bi bi-cash-stack text-success fs-4"></i>
							</div>
							<div class="d-flex align-items-baseline">
								<span class="display-6 fw-bold text-dark">
									{% if consumption and consumption.estimatedPrice is not null %}
										{{ consumption.estimatedPrice|number_format(2, ',', ' ') }}
									{% else %}
										0,00
									{% endif %}
								</span>
								<span class="h4 mb-0 ms-2 text-success">€</span>
							</div>
						</div>
					</div>

					{# Bloc Volume #}
					<div class="col-12">
						<div class="px-2">
							<div class="d-flex justify-content-between align-items-center mb-1">
								<span class="text-muted small text-uppercase fw-semibold">Consommation estimée</span>
								<span class="fw-bold text-primary">{{ consumption.totalKwh|default(0)|number_format(0, ',', ' ') }} kWh</span>
							</div>
							{# Barre de progression visuelle (optionnelle : max à 1000kWh pour l'exemple) #}
							<div class="progress" style="height: 8px;">
								{% set raw_percentage = (consumption.totalKwh|default(0) / 1000) * 100 %}
								{% set percentage = min(raw_percentage, 100) %}
								{% set percentage = max(percentage, 0) %}
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-primary rounded-pill" 
										role="progressbar" 
										style="width: {{ percentage }}%" 
										aria-valuenow="{{ percentage }}" 
										aria-valuemin="0" 
										aria-valuemax="100">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				{# Footer avec Date - Style "Impact Global" #}
				{% if consumption %}
					<div class="mt-4 pt-2 border-top d-flex justify-content-between align-items-center">
						<small class="text-muted" style="font-size: 0.7rem;">
							<i class="fas fa-history me-1"></i> 
							{{ consumption.billingDate|date('d/m/Y') }}
						</small>
						
						<a href="{{ path('app_calculator_consumption') }}" 
						class="text-decoration-none small fw-bold text-success" 
						style="font-size: 0.75rem;">
							Mettre à jour <i class="fas fa-chevron-right ms-1"></i>
						</a>
					</div>
				{% endif %}
			</div>
		</section>

		{# Alertes #}
		<section class="card">
			<h2 style="font-size: 1.4rem">Alertes Intelligentes</h2>

			{% if smart_alerts is defined and smart_alerts is not empty %}
				<div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
					{% for alert in smart_alerts %}
						<div class="alert alert-{{ alert.type }} d-flex align-items-center mb-0" role="alert" style="border-left: 5px solid {% if alert.type == 'warning' %}#ffc107{% elseif alert.type == 'danger' %}#dc3545{% else %}#198754{% endif %};">
							<i class="{{ alert.icon }} me-3" style="font-size: 1.5rem;"></i>
							<div>
								<h5 class="alert-heading h6 fw-bold mb-1">{{ alert.title }}</h5>
								<p class="mb-0 small">{{ alert.message|raw }}</p>
							</div>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<div class="alert alert-success d-flex align-items-center mt-3" role="alert">
					<i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
					<div>
						<h5 class="alert-heading h6 fw-bold mb-1">Tout va bien !</h5>
						<p class="mb-0 small">Aucune alerte de consommation détectée pour le moment.</p>
					</div>
				</div>
			{% endif %}
		</section>
	</div>
</div>

{# MODALE SUGGESTIONS #}
{% if suggestions_carbone is defined and suggestions_carbone|length > 3 %}
	<div class="modal fade" id="suggestionsModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header" style="background: var(--vert-energreen); color: white;">
					<h5 class="modal-title">Tous vos conseils Carbone</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					{% for categorie, message in suggestions_carbone %}
						<div class="mb-3 p-2" style="border-bottom: 1px solid #eee;">
							<strong style="color: var(--vert-energreen);">{{ categorie }}</strong>
							<p class="small mb-0">{{ message }}</p>
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
{% endif %}{% endblock %}
{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
window.addEventListener('load', function () {

    /* ========= GRAPHIQUE LINÉAIRE (Consommation Élec) ========= */
    const lineCtx = document.getElementById('consumptionChart');
    if (lineCtx) {
        try {
            const existingChart = Chart.getChart(lineCtx);
            if (existingChart) existingChart.destroy();

            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: {{ labelsMois|raw }},
                    datasets: [{
                        label: 'Consommation (kWh)',
                        data: {{ dataMois|raw }},
                        borderColor: '#1a3020',
                        backgroundColor: 'rgba(26, 48, 32, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        } catch (e) { console.error("❌ Erreur Linéaire:", e); }
    }

    /* ========= GRAPHIQUE LINÉAIRE (Évolution Carbone Total) ========= */
    const carbonCtx = document.getElementById('carbonChart');
    if (carbonCtx) {
        try {
            new Chart(carbonCtx, {
                type: 'line',
                data: {
                    labels: {{ labelsBilan|raw }}, 
                    datasets: [{
                        label: 'Empreinte Totale (kg CO2e)',
                        data: {{ dataBilanTotal|raw }},
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#27ae60'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' kg CO2e';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'kg CO2e' } 
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        } catch (e) { console.error("❌ Erreur Évolution Carbone:", e); }
    }

    /* ========= GRAPHIQUE DONUT (Impact Global) ========= */
    const donutCtx = document.getElementById('impactChart');
    if (donutCtx) {
        {% if latest_bilan is defined and latest_bilan %}
        try {
            new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Logement', 'Numérique', 'Alimentation', 'Transports', 'Électroménager', 'Textile'],
                    datasets: [{
                        data: [
                            {{ latest_bilan.logement|default(0) }},
                            {{ latest_bilan.numerique|default(0) }},
                            {{ latest_bilan.alimentation|default(0) }},
                            {{ latest_bilan.transports|default(0) }},
                            {{ latest_bilan.electromenager|default(0) }},
                            {{ latest_bilan.textile|default(0) }}
                        ],
                        backgroundColor: ['#2ecc71', '#3498db', '#f1c40f', '#e74c3c', '#1abc9c', '#9b59b6'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '82%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: '#1a3020' }
                    }
                }
            });
        } catch (e) { console.error("❌ Erreur Donut:", e); }
        {% endif %}
    }
});

function switchChart(type) {
    const btnElec = document.getElementById('btn-elec');
    const btnCarbon = document.getElementById('btn-carbon');
    const containerElec = document.getElementById('container-elec');
    const containerCarbon = document.getElementById('container-carbon');
    const description = document.getElementById('chartDescription');

    if (type === 'elec') {
        containerElec.classList.remove('d-none');
        containerCarbon.classList.add('d-none');
        
        // On gère uniquement la classe 'active'
        btnElec.classList.add('active');
        btnCarbon.classList.remove('active');
        
        description.innerText = "{{ infoMois }}";
    } else {
        containerElec.classList.add('d-none');
        containerCarbon.classList.remove('d-none');
        
        // On gère uniquement la classe 'active'
        btnCarbon.classList.add('active');
        btnElec.classList.remove('active');
        
        description.innerText = "Évolution de votre empreinte carbone totale au fil de vos bilans";
    }
}
</script>
{% endblock %}