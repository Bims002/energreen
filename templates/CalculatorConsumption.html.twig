{% extends 'base.html.twig' %}

{% block title %}Consommation électrique{% endblock %}

{% block body %}
    <style>
        body { font-size: 0.85rem; }
        .bg-form { background-color: #493315 !important; color: white; }
        .result-span { font-size: 0.95rem; font-weight: bold; }
        .appliance-name { font-size: 0.9rem; font-weight: 600; }
        .qty-container {
            display: flex; align-items: center; background: #f8f9fa;
            padding: 2px 6px; border-radius: 4px; border: 1px solid #dee2e6;
        }
        .qty-input {
            width: 35px; border: none; background: transparent;
            text-align: center; font-weight: bold; font-size: 0.8rem;
        }
        .btn-info-circle {
            width: 16px; height: 16px; border-radius: 50%; padding: 0;
            line-height: 14px; font-size: 0.65rem; font-weight: bold;
            display: inline-flex; align-items: center; justify-content: center;
        }
    </style>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-11">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-form text-white text-center py-2">
                        <h5 class="mb-0">Calculer votre consommation électrique</h5>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-4 border-end">
                                <h6 class="fw-bold mb-3">Résumé & Paramètres</h6>
                                
                                <div class="bg-light p-2 rounded border border-warning mb-2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <small class="text-muted">Inclus :</small>
                                        <button type="button" class="btn btn-outline-warning btn-info-circle" data-bs-toggle="modal" data-bs-target="#modalVeille">?</button>
                                    </div>
                                    <span class="fw-bold text-dark small">Veille (18 kWh/mois)</span>
                                </div>

                                <div class="bg-light p-2 rounded border border-info mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <small class="text-muted">Tarif appliqué :</small>
                                        <button type="button" class="btn btn-outline-info btn-info-circle" data-bs-toggle="modal" data-bs-target="#modalTarif">?</button>
                                    </div>
                                    <span class="fw-bold text-dark small">0.25 € / kWh</span>
                                </div>

                                <div class="modal fade" id="modalVeille" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content text-dark">
                                            <div class="modal-header bg-warning">
                                                <h5 class="modal-title">Pourquoi 18 kWh de veille ?</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Même éteints, vos appareils consomment de l'énergie s'ils restent branchés. Nous incluons un forfait moyen de <strong>18 kWh par mois</strong> qui correspond à :</p>
                                                <ul>
                                                    <li>Votre box internet (allumée 24h/24)</li>
                                                    <li>Les voyants LED de la TV et du four</li>
                                                    <li>Les chargeurs laissés sur les prises</li>
                                                    <li>Les horloges des appareils électroménagers</li>
                                                </ul>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal fade" id="modalTarif" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content text-dark">
                                            <div class="modal-header bg-info text-white">
                                                <h5 class="modal-title">Détails du tarif électrique</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Nous utilisons un tarif de <strong>0.25 € par kWh</strong> pour nos calculs.</p>
                                                <p>Ce montant correspond au tarif réglementé moyen actuel en France (TTC). Il inclut l'abonnement et les taxes locales pour un foyer standard.</p>
                                                <p class="small text-muted">Note : Ce prix peut varier selon votre fournisseur d'énergie et votre type de contrat (Heures Pleines / Heures Creuses).</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                    <div class="d-grid">
                                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addApplianceModal">
                                            <i class="fas fa-plus"></i> Gérer mes appareils
                                        </button>
                                    </div>
                                </div>

                            <div class="col-md-8">
                                <form id="calcForm" onsubmit="event.preventDefault(); calculateConsumption();">
                                    <div id="appliance-list">
                                        {% for app in appliances %}
                                            <div class="mb-3 appliance-row border-bottom pb-2">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="appliance-name text-dark">{{ app.name }}</span>
                                                    <div class="qty-container">
                                                        <span class="text-muted me-1" style="font-size: 0.7rem;">Qté :</span>
                                                        <input type="number" class="qty-input quantity-input" value="1" min="1" oninput="calculateConsumption()">
                                                    </div>
                                                </div>

                                                <div class="row g-2 align-items-center">
                                                    <div class="col-4">
                                                        <label class="text-muted d-block small">Watts</label>
                                                        <input type="number" class="form-control form-control-sm power-input" value="{{ app.power }}" oninput="calculateConsumption()">
                                                    </div>
                                                    <div class="col-5">
                                                        {# Gestion du mode (Cycles ou Heures) #}
                                                        {% if app.mode == 'cycles_week' or app.mode == 'Charge' or app.mode == 'Coton 40°' %}
                                                            <label class="text-muted d-block small">Cycles / sem.</label>
                                                            <input type="number" step="1" class="form-control form-control-sm hours-input" value="{{ app.usageAppliance }}" data-cycle-duration="{{ app.duration|default(1) }}" oninput="calculateConsumption()">
                                                            <input type="hidden" class="mode-input" value="cycles_week">
                                                        {% else %}
                                                            <label class="text-muted d-block small">Heures / jour</label>
                                                            <input type="number" step="0.5" class="form-control form-control-sm hours-input" value="{{ app.usageAppliance }}" oninput="calculateConsumption()">
                                                            <input type="hidden" class="mode-input" value="hours_day">
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-3 text-end pt-3">
                                                        <span class="result-span text-success">-</span> <small class="text-muted">kWh</small>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <div class="mt-3 bg-dark text-white p-3 rounded shadow-sm">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Consommation mensuelle :</span>
                                            <span id="total-consumption">0 kWh</span>
                                        </div>
                                        <div class="d-flex justify-content-between border-top pt-2">
                                            <span class="fw-bold">Coût estimé :</span>
                                            <span class="text-warning fw-bold" id="total-cost" style="font-size: 1rem;">0 €</span>
                                        </div>
                                        <div class="row mt-3 g-2">
                                            <div class="col"><a href="{{ path('app_dashboard') }}" class="btn btn-outline-light btn-sm w-100">Retour</a></div>
                                            <div class="col"><button type="submit" class="btn btn-warning btn-sm w-100 text-dark fw-bold">Recalculer</button></div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addApplianceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-dark">
                <div class="modal-header bg-success text-white py-2">
                    <h6 class="modal-title">Ma bibliothèque d'appareils</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" style="max-height: 450px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% if allAppliances is defined %}
                            <div class="list-group list-group-flush">
                                {% for item in allAppliances %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-2 text-dark">
                                        <div>
                                            <span class="fw-bold d-block small text-dark">{{ item.name }}</span>
                                            <small class="text-muted">{{ item.power }}W | {{ item.mode }}</small>
                                        </div>
                                        
                                        <form action="{{ path('appliance_toggle', {'id': item.id}) }}" method="POST">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                    onchange="this.form.submit()" 
                                                    {% if item.name in userApplianceNames %}checked{% endif %}>
                                            </div>
                                        </form>
                                    </div>
                                {% else %}
                                    <div class="p-3 text-center text-muted">
                                        Aucun appareil trouvé dans la base de données.
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function calculateConsumption() {
            const rows = document.querySelectorAll('.appliance-row');
            let totalMonthly = 0;
            const electricityRate = 0.25;

            rows.forEach(row => {
                const power = parseFloat(row.querySelector('.power-input').value) || 0;
                const usage = parseFloat(row.querySelector('.hours-input').value) || 0;
                const quantity = parseInt(row.querySelector('.quantity-input').value) || 1;
                const mode = row.querySelector('.mode-input') ? row.querySelector('.mode-input').value : 'hours_day';
                
                let kwh = 0;
                if (mode === 'cycles_week') {
                    // Calcul : (Watts * Heures_par_cycle * Cycles_par_semaine * 4.33 semaines) / 1000
                    const duration = parseFloat(row.querySelector('.hours-input').dataset.cycleDuration) || 1;
                    kwh = (power * duration * usage * 4.33 * quantity) / 1000;
                } else {
                    // Calcul : (Watts * Heures_par_jour * 30 jours) / 1000
                    kwh = (power * usage * 30 * quantity) / 1000;
                }

                row.querySelector('.result-span').textContent = kwh.toFixed(2);
                totalMonthly += kwh;
            });

            totalMonthly += 18; // Ajout forfaitaire des veilles
            document.getElementById('total-consumption').textContent = totalMonthly.toFixed(2) + ' kWh';
            document.getElementById('total-cost').textContent = (totalMonthly * electricityRate).toFixed(2) + ' €';
        }

        window.onload = calculateConsumption;

        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
{% endblock %}